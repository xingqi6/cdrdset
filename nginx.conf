server {
    # 监听 Hugging Face 的默认端口
    listen 7860 default_server;
    server_name _;

    # === 1. 默认首页：环境保护静态伪装页 ===
    # 任何人直接访问域名，只显示 fake_site/index.html
    location = / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # === 2. 秘密入口：Cloudreve ===
    # 访问 /xmj 时，转发到内部 Cloudreve (端口 5212)
    location /xmj {
        # 去掉 URL 中的 /xmj 前缀再转发
        rewrite ^/xmj(.*) /$1 break;
        
        proxy_pass http://127.0.0.1:5212;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # === 3. 临时配置区域 (Alist) ===
    # !!! 警告：配置完成后请删除此区域 !!!
    # 访问 /alist 进入 Alist 管理后台 (端口 5244)
    location /alist {
        rewrite ^/alist(.*) /$1 break;
        proxy_pass http://127.0.0.1:5244;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    # Alist 需要加载 /assets 资源，必须临时放行，否则后台也是白屏
    location /assets {
        proxy_pass http://127.0.0.1:5244;
    }
    # ===============================

    # === 4. 放行 Cloudreve 的必要接口 ===
    # 为了让 Cloudreve 正常显示，必须放行以下系统路径
    location /static { proxy_pass http://127.0.0.1:5212; }
    location /api { proxy_pass http://127.0.0.1:5212; }
    location /dav { proxy_pass http://127.0.0.1:5212; }
    location /uploads { proxy_pass http://127.0.0.1:5212; }
    location /manifest.json { proxy_pass http://127.0.0.1:5212; }
    location /favicon.ico { proxy_pass http://127.0.0.1:5212; }
}
